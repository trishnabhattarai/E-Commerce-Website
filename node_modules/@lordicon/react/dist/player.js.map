{"version":3,"file":"player.js","sources":["../src/player.tsx"],"sourcesContent":["import { isNil } from '@lordicon/helpers';\nimport lottie, { AnimationConfig, AnimationItem } from 'lottie-web';\nimport React from 'react';\nimport { IPlayer, IPlayerOptions, IState } from './interfaces';\n\ntype LottieOptions = Omit<AnimationConfig, 'container'>;\n\ntype PlayerState = {}\n\ntype Options = IPlayerOptions;\n\nconst DEFAULT_LOTTIE_WEB_OPTIONS: Omit<AnimationConfig, 'container'> = {\n    renderer: \"svg\",\n    loop: false,\n    autoplay: false,\n    rendererSettings: {\n        preserveAspectRatio: \"xMidYMid meet\",\n        progressiveLoad: true,\n        hideOnTransparent: true,\n    },\n}\n\n/**\n * Use constructable stylesheets if supported (https://developers.google.com/web/updates/2019/02/constructable-stylesheets)\n */\nconst SUPPORTS_ADOPTING_STYLE_SHEETS = 'adoptedStyleSheets' in Document.prototype && 'replace' in CSSStyleSheet.prototype;\n\nconst ELEMENT_STYLE = `\n    :host {\n        position: relative;\n        display: block;\n        transform: translate3d(0px, 0px, 0px);\n        width: 100%;\n        aspect-ratio: 1/1;\n        overflow: hidden;\n    }\n\n    :host(.colorize) svg path[fill] {\n        fill: currentColor;\n    }\n\n    :host(.colorize) svg path[stroke] {\n        stroke: currentColor;\n    }\n\n    svg {\n        position: absolute;\n        pointer-events: none;\n        display: block;\n        transform: unset!important;\n    }\n\n    ::slotted(*) {\n        position: absolute;\n        left: 0;\n        top: 0;\n        width: 100%;\n        height: 100%;\n    }\n\n    .body.ready ::slotted(*) {\n        display: none;\n    }\n`;\n\n/**\n * Current style sheet instance (if supported).\n */\nlet styleSheet: CSSStyleSheet;\n\nexport class Player extends React.Component<Options, PlayerState> implements IPlayer {\n    protected _ref?: React.RefObject<HTMLDivElement>;\n    \n    protected _states: IState[] = [];\n    protected _state?: IState;\n    protected  _root?: ShadowRoot;\n    \n    protected _lottie?: AnimationItem;\n    \n    constructor(props: Options) {\n        super(props);\n\n        this._ref = React.createRef<HTMLDivElement>();\n    }\n\n    connect() {\n        if (!this.props.icon) {\n            return;\n        }\n\n        this._states = (this.props.icon.markers || []).map((c: any) => {\n            const [partA, partB] = c.cm.split(':');\n            const newState: IState = {\n                time: c.tm,\n                duration: c.dr,\n                name: partB || partA,\n                default: partB && partA.includes('default') ? true : false,\n            };\n\n            if (newState.name === this.props.state) {\n                this._state = newState;\n            } else if (newState.default && isNil(this.props.state)) {\n                this._state = newState;\n            }\n\n            return newState;\n        });\n        \n        if (this._states.length) {\n            const firstState = this._states[0];\n            const lastState = this._states[this._states.length - 1];\n\n            // fix animation time\n            this.props.icon.ip = firstState.time;\n            this.props.icon.op = lastState.time + lastState.duration + 1;\n        }\n\n        const container: any = this._root!.lastElementChild;\n        const initialOptions: LottieOptions = {};\n\n        if (this._state) {\n            initialOptions.initialSegment = [this._state.time, this._state.time + this._state.duration + 1];\n        }\n\n        this._lottie = lottie.loadAnimation({\n            container,\n            animationData: this.props.icon,\n            ...initialOptions,\n            ...DEFAULT_LOTTIE_WEB_OPTIONS,\n        });\n\n        this._lottie!.setDirection(this.props.direction || 1);\n\n        this._lottie.addEventListener('complete', (e) => {\n            this.onFinish();\n        });\n\n        if (this._lottie.isLoaded) {\n            this.onReady();\n        } else {\n            this._lottie.addEventListener('config_ready', () => {\n                this.onReady();\n            });\n        }\n    }\n\n    disconnect() {\n        if (!this._lottie) {\n            return;\n        }\n\n        this._lottie.destroy();\n        this._lottie = undefined;\n    }\n\n    componentDidMount() {\n        if (!this._root) {\n            this._root = this._ref?.current!.attachShadow({\n                mode: \"open\"\n            })!;\n    \n            // stylesheet\n            if (SUPPORTS_ADOPTING_STYLE_SHEETS) {\n                if (!styleSheet) {\n                    styleSheet = new CSSStyleSheet();\n                    styleSheet.replaceSync(ELEMENT_STYLE);\n                }\n    \n                this._root.adoptedStyleSheets = [styleSheet];\n            } else {\n                const style = document.createElement(\"style\");\n                style.innerHTML = ELEMENT_STYLE;\n                this._root.appendChild(style);\n            }\n    \n            // create container\n            const container = document.createElement(\"div\");\n            container.classList.add('body');\n            this._root.appendChild(container);\n        }\n   \n        this.connect();\n    }\n\n    componentWillUnmount() {\n        this.disconnect();\n    }\n\n    componentDidUpdate(prevProps: Options, prevState: PlayerState) {\n        if (prevProps.state !== this.props.state) {\n            this.onStateChanged();\n        }\n\n        if (prevProps.direction !== this.props.direction) {\n            this.onDirectionChanged();\n        }\n\n        if (prevProps.icon !== this.props.icon) {\n            this.onIconChanged();\n        }\n    }\n\n    onFinish() {\n        this.props.onComplete?.();\n    }\n\n    onDirectionChanged() {\n        this._lottie!.setDirection(this.props.direction!);\n    }\n\n    onStateChanged() {\n        const isPlaying = this.isPlaying;\n\n        this._state = undefined;\n\n        if (isNil(this.props.state)) {\n            this._state = this._states.filter(c => c.default)[0];\n        } else if (this.props.state) {\n            this._state = this._states.filter(c => c.name === this.props.state)[0];\n        }\n\n        if (this._state) {\n            this._lottie?.setSegment(this._state.time, this._state.time + this._state.duration + 1);\n        } else {\n            this._lottie!.resetSegments(true);\n        }\n\n        this.goToFirstFrame();\n\n        if (isPlaying) {\n            this.pause();\n            this.play();\n        }\n    }\n\n    onIconChanged() {\n        this.disconnect();\n        this.connect();\n    }\n\n    onReady() {\n        this.props.onReady?.();\n    }\n\n    play() {\n        this._lottie!.play();\n    }\n\n    playFromBeginning() {\n        if (this._state) {\n            const a = this._state.time;\n            const b = this._state.time + this._state.duration + 1;\n            const c: [number, number] = [a, b];\n\n            this._lottie!.playSegments(c, true);\n        } else {\n            this._lottie!.goToAndPlay(0);\n        }\n    }\n\n    pause() {\n        this._lottie!.pause();\n    }\n\n    goToFirstFrame() {\n        this.goToFrame(0);\n    }\n\n    goToLastFrame() {\n        this.goToFrame(Math.max(0, this.frames));\n    }\n\n    goToFrame(frame: number) {\n        this._lottie!.goToAndStop(frame, true);\n    }\n\n    refresh() {\n        this._lottie?.renderer.renderFrame(null);\n    }\n\n    render() {\n        const size: number = this.props.size || 32;\n        const color: string|undefined = this.props.colorize || undefined;\n        \n        return (\n            <div ref={this._ref} className={this.props.colorize ? 'colorize' : undefined} style={{width: size, height: size, color, aspectRatio: 1, flexDirection: 'row'}}></div>\n        );\n    }\n\n    get frames() {\n        return this._lottie!.getDuration(true) - 1;\n    }\n\n    get isPlaying() {\n        return !this._lottie!.isPaused;\n    }\n\n    get states() {\n        return this._states;\n    }\n\n    get currentState() {\n        return this._state;\n    }\n}"],"names":["DEFAULT_LOTTIE_WEB_OPTIONS","renderer","loop","autoplay","rendererSettings","preserveAspectRatio","progressiveLoad","hideOnTransparent","SUPPORTS_ADOPTING_STYLE_SHEETS","Document","prototype","CSSStyleSheet","ELEMENT_STYLE","styleSheet","Player","React","Component","_ref","_states","_state","_root","_lottie","constructor","props","super","this","createRef","connect","icon","markers","map","c","partA","partB","cm","split","newState","time","tm","duration","dr","name","default","includes","state","isNil","length","firstState","lastState","ip","op","container","lastElementChild","initialOptions","initialSegment","lottie","loadAnimation","animationData","setDirection","direction","addEventListener","e","onFinish","isLoaded","onReady","disconnect","destroy","undefined","componentDidMount","current","attachShadow","mode","replaceSync","adoptedStyleSheets","style","document","createElement","innerHTML","appendChild","classList","add","componentWillUnmount","componentDidUpdate","prevProps","prevState","onStateChanged","onDirectionChanged","onIconChanged","onComplete","isPlaying","filter","setSegment","resetSegments","goToFirstFrame","pause","play","playFromBeginning","playSegments","goToAndPlay","goToFrame","goToLastFrame","Math","max","frames","frame","goToAndStop","refresh","renderFrame","render","size","color","colorize","_jsx","ref","className","width","height","aspectRatio","flexDirection","getDuration","isPaused","states","currentState"],"mappings":"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"}